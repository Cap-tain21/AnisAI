<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Quartz Catcher â€” Android</title>
<style>
  :root{--hud:#66ffff}
  html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-user-select:none;touch-action:none}
  canvas{display:block;width:100vw;height:100vh;}
  #score{position:fixed;left:12px;top:12px;color:var(--hud);font:600 16px/1 monospace;text-shadow:0 0 8px rgba(102,255,255,0.12);z-index:20}
  #high{position:fixed;right:12px;top:12px;color:var(--hud);font:600 16px/1 monospace;text-shadow:0 0 8px rgba(102,255,255,0.12);z-index:20}
  /* central single action button (Start / Stop / Resume) */
  #actionBtn {
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    top:46px;
    z-index:30;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.08);
    color:var(--hud);
    padding:8px 14px;
    border-radius:10px;
    font-weight:700;
  }
  /* initial full-screen start overlay */
  #startOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:40;background:linear-gradient(0deg, rgba(0,0,0,0.6), rgba(0,0,0,0.25));}
  #startCard{background:rgba(8,10,16,0.95);padding:18px;border-radius:12px;text-align:center;color:#cfe;max-width:92%;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  #startCard h1{margin:0 0 8px 0;font-size:20px}
  #startCard small{display:block;margin-top:8px;color:#9fd}
  @media (min-width:600px){ #startCard{max-width:420px} }
</style>
</head>
<body>
<div id="score">Score: 0</div>
<div id="high">High: 0</div>

<button id="actionBtn" aria-label="game action" style="display:none">Start</button>

<canvas id="game"></canvas>

<div id="startOverlay">
  <div id="startCard">
    <h1>Quartz Catcher</h1>
    <div style="margin:12px 0">
      <button id="startBtn" style="font-size:18px;padding:10px 20px;border-radius:10px;background:var(--hud);border:none;font-weight:700;color:#012">Start Game</button>
    </div>
    <small>Touch to move pad. Single quartz falls. If one falls you lose. Game speed resets on new game.</small>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d'); // REMOVED {alpha:false} for Android compatibility
  const scoreEl = document.getElementById('score');
  const highEl = document.getElementById('high');
  const actionBtn = document.getElementById('actionBtn');
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.getElementById('startBtn');

  // Android WebView compatibility fixes
  let dpr = window.devicePixelRatio || 1;
  let W=0,H=0;
  
  function resize(){ 
    W = canvas.width = window.innerWidth * dpr;
    H = canvas.height = window.innerHeight * dpr;
    
    // Scale canvas CSS size to match device pixels
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    
    // Scale the context to handle high DPI displays
    ctx.scale(dpr, dpr);
    
    player.baseY = Math.max(50, window.innerHeight - 86);
    player.x = Math.min(Math.max(player.x,0), window.innerWidth - player.w);
  }
  window.addEventListener('resize', resize, { passive: true });

  // HUD state
  let score = 0;
  let high = parseInt(localStorage.getItem('qc_high')||'0',10) || 0;
  scoreEl.textContent = 'Score: ' + score;
  highEl.textContent = 'High: ' + high;

  // player pad
  const player = { 
    x:0, 
    w:120, 
    h:18, 
    baseY:0, 
    hue:190, 
    bounce:0, 
    speed:14, 
    color(){ return 'hsl('+this.hue+',100%,50%)' } 
  };

  // speed control parameters
  const BASE_SPEED = 6;
  const SPEED_PER_SEC = 0.01;
  const SPEED_PER_CATCH = 0.03;
  const SPEED_CAP = 16;
  let elapsedRunningMs = 0;
  let quartz = null;
  let particles = [];

  function makeQuartz(speedOverride){ 
    return {
      x: Math.random() * Math.max(1, window.innerWidth - 34),
      y: -40 - Math.random()*160,
      size: 28,
      baseSpeed: (typeof speedOverride === 'number') ? speedOverride : BASE_SPEED,
      speed: (typeof speedOverride === 'number') ? speedOverride : BASE_SPEED,
      hue: Math.random()*360,
      trail: []
    }; 
  }

  quartz = makeQuartz();

  // stars field - FIXED for Android WebView
  const stars = [];
  const starCount = 80; // Reduced for performance
  for(let i=0; i<starCount; i++) {
    stars.push({ 
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight, 
      r: Math.random()*1.5+0.8, 
      base: Math.random()*0.6+0.12, 
      speed: Math.random()*0.08+0.01, 
      phase: Math.random()*Math.PI*2 
    });
  }

  // state: 'stopped' | 'running' | 'paused'
  let state = 'stopped';
  let lastFrame = 0;

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  function vibrate(ms){ if('vibrate' in navigator) navigator.vibrate(ms); }

  // drawing helpers - OPTIMIZED for Android
  function drawNight(now){
    // Simple solid background for Android compatibility
    ctx.fillStyle = '#000010';
    ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
    
    // Draw stars with simplified rendering
    for(const s of stars){
      // Reset star if it goes off screen
      if(s.y > window.innerHeight) {
        s.y = 0;
        s.x = Math.random() * window.innerWidth;
      }
      
      const a = clamp(s.base + 0.3 * Math.sin(now/1200 + s.phase), 0.04, 1);
      ctx.beginPath(); 
      ctx.fillStyle = 'rgba(255,255,255,'+a+')'; 
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); 
      ctx.fill();
      
      s.y += s.speed;
    }
  }

  function drawPlayer(){
    const yOff = Math.sin(player.bounce) * 6;
    ctx.save(); 
    ctx.fillStyle = player.color(); 
    // Simplified shadow for Android
    ctx.shadowBlur = 12; 
    ctx.shadowColor = player.color();
    ctx.fillRect(player.x, player.baseY - yOff, player.w, player.h); 
    ctx.restore();
  }

  function drawQuartz(q){
    q.hue = (q.hue + 2.4) % 360;
    
    // Simplified trail for Android performance
    for(let i=0; i<q.trail.length; i++){
      const t = q.trail[i], alpha = 1 - (i / q.trail.length);
      ctx.save(); 
      ctx.fillStyle = 'hsla(' + q.hue + ',100%,50%,' + (alpha*0.12) + ')';
      ctx.beginPath(); 
      ctx.arc(t.x, t.y, (q.size * alpha) * 0.4, 0, Math.PI*2); 
      ctx.fill(); 
      ctx.restore();
    }
    
    ctx.save(); 
    ctx.beginPath(); 
    ctx.fillStyle = 'hsl(' + q.hue + ',100%,50%)';
    // Reduced shadow for Android
    ctx.shadowBlur = 12; 
    ctx.shadowColor = 'hsl(' + q.hue + ',100%,60%)';
    ctx.arc(q.x + q.size/2, q.y + q.size/2, q.size/2, 0, Math.PI*2); 
    ctx.fill(); 
    ctx.restore();
    
    q.trail.unshift({ x: q.x + q.size/2, y: q.y + q.size/2 }); 
    if(q.trail.length > 12) q.trail.pop(); // Reduced trail length
  }

  function spawnParticles(x,y,hue){
    for(let i=0;i<8;i++){ // Reduced particle count
      const a = Math.random()*Math.PI*2, s = 1 + Math.random()*2.2;
      particles.push({ 
        x:x+(Math.random()-0.5)*8, 
        y:y+(Math.random()-0.5)*8, 
        vx:Math.cos(a)*s, 
        vy:Math.sin(a)*s*0.6, 
        s:Math.random()*3+2, 
        color:'hsl('+(hue + (Math.random()*40-20))+',100%,60%)', 
        life:20 + Math.floor(Math.random()*15) 
      });
    }
  }

  function drawParticles(){
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      ctx.save(); 
      ctx.fillStyle = p.color; 
      ctx.beginPath(); 
      ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); 
      ctx.fill(); 
      ctx.restore();
      p.x += p.vx; 
      p.y += p.vy; 
      p.s *= 0.94; 
      p.life--; 
      if(p.s < 0.6 || p.life <= 0) particles.splice(i,1);
    }
  }

  // reset to fresh state
  function resetToFresh(){
    elapsedRunningMs = 0;
    quartz = makeQuartz(BASE_SPEED);
    player.w = 120;
    player.hue = 190;
    player.bounce = 0;
  }

  // game over function
  function gameOver(){
    if(score > high){ 
      high = score; 
      localStorage.setItem('qc_high', String(high)); 
      highEl.textContent = 'High: ' + high; 
    }
    score = 0; 
    scoreEl.textContent = 'Score: ' + score;
    resetToFresh();
    state = 'stopped';
    startOverlay.style.display = 'flex';
    actionBtn.style.display = 'none';
  }

  // update per frame
  function update(dt){
    if(state !== 'running') return;
    
    elapsedRunningMs += dt;

    // compute dynamic speed
    const timeBoost = (elapsedRunningMs / 1000) * SPEED_PER_SEC;
    const catchBoost = score * SPEED_PER_CATCH;
    const targetSpeed = clamp(BASE_SPEED + timeBoost + catchBoost, BASE_SPEED, SPEED_CAP);
    
    // move quartz
    quartz.speed = targetSpeed;
    quartz.y += quartz.speed * (dt / 16.67);

    // miss detection
    if(quartz.y > window.innerHeight){
      vibrate(170);
      gameOver();
      return;
    }

    // collision check
    const qBottom = quartz.y + quartz.size;
    if(qBottom > player.baseY && quartz.y < player.baseY + player.h){
      if(quartz.x + quartz.size > player.x && quartz.x < player.x + player.w){
        // caught
        score++;
        scoreEl.textContent = 'Score: ' + score;
        spawnParticles(quartz.x + quartz.size/2, quartz.y + quartz.size/2, quartz.hue);
        player.hue = quartz.hue;
        quartz.x = Math.random() * Math.max(1, window.innerWidth - quartz.size);
        quartz.y = -40 - Math.random() * 160;
        quartz.trail.length = 0;
        player.bounce += 0.5;
      }
    }
    player.bounce *= 0.92;
  }

  // main loop
  function loop(now){
    if(!lastFrame) lastFrame = now;
    const dt = Math.min(50, now - lastFrame);
    lastFrame = now;

    if(state === 'running') update(dt);
    
    // Clear with dimensions in CSS pixels
    ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    drawNight(now);
    drawParticles();
    drawQuartz(quartz);
    drawPlayer();

    requestAnimationFrame(loop);
  }

  // Android-optimized input handling
  canvas.addEventListener('touchmove', e=>{
    if(e.touches.length > 0){
      const t = e.touches[0];
      const px = t.clientX;
      player.x = clamp(px - player.w/2, 0, window.innerWidth - player.w);
      e.preventDefault();
    }
  }, { passive: false });

  canvas.addEventListener('mousedown', e=>{
    const px = e.clientX;
    player.x = clamp(px - player.w/2, 0, window.innerWidth - player.w);
  });

  // single action button logic
  actionBtn.addEventListener('click', ()=>{
    if(state === 'stopped'){
      startOverlay.style.display = 'none';
      actionBtn.style.display = 'inline-block';
      actionBtn.textContent = 'Stop';
      score = 0; 
      scoreEl.textContent = 'Score: ' + score;
      resetToFresh();
      state = 'running';
      lastFrame = performance.now();
      requestAnimationFrame(loop);
    } else if(state === 'running'){
      state = 'paused';
      actionBtn.textContent = 'Resume';
    } else if(state === 'paused'){
      state = 'running';
      actionBtn.textContent = 'Stop';
      lastFrame = performance.now();
      requestAnimationFrame(loop);
    }
  });

  // start overlay button
  startBtn.addEventListener('click', ()=>{
    startOverlay.style.display = 'none';
    actionBtn.style.display = 'inline-block';
    actionBtn.textContent = 'Stop';
    score = 0; 
    scoreEl.textContent = 'Score: ' + score;
    resetToFresh();
    state = 'running';
    lastFrame = performance.now();
    requestAnimationFrame(loop);
  });

  // Android-optimized initialization
  function init(){
    player.x = (window.innerWidth - player.w) * 0.5;
    resize();
    
    // Reinitialize stars for current screen size
    stars.length = 0;
    for(let i=0; i<starCount; i++) {
      stars.push({ 
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight, 
        r: Math.random()*1.5+0.8, 
        base: Math.random()*0.6+0.12, 
        speed: Math.random()*0.08+0.01, 
        phase: Math.random()*Math.PI*2 
      });
    }
    
    actionBtn.style.display = 'none';
    
    // initial draw
    ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    drawNight(performance.now());
    drawQuartz(quartz);
    drawPlayer();
  }

  // Start when DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // expose reset for debug
  window.qcReset = ()=>{ gameOver(); };
})();
</script>
</body>
</html>
